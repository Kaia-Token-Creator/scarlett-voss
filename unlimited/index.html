<!-- /unlimited/index.html : 변경된 부분만 반영 (기능 동일) -->
<script>
/** ------------ Config ------------ **/
const API_PATH = "/api/unlimited";   /* ← 서버 새 라우트로 교체 */

/** ------------ State ------------ **/
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const sendEl = document.getElementById("send");
const clearEl = document.getElementById("clear");
const tipLink = document.getElementById("tipLink");
const tipModal = document.getElementById("tipModal");
const tipClose = document.getElementById("tipClose");
const galleryLink = document.getElementById("galleryLink");
const galleryModal = document.getElementById("galleryModal");
const galleryClose = document.getElementById("galleryClose");
const rulesModal = document.getElementById("rulesModal");
const rulesAgree = document.getElementById("rulesAgree");

/* 클라이언트엔 시스템 프롬프트/모델 없음 */
let conversation = [];

/** ------------ UI Helpers ------------ **/
function addAssistant(text){
  const row = document.createElement("div");
  row.className = "row assistant";
  row.innerHTML = `
    <div class="avatar assistant">
      <img src="/voss.jpg" alt="Scarlett Voss" />
    </div>
    <div class="bubble">${escapeHtml(text)}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function addUser(text){
  const row = document.createElement("div");
  row.className = "row user";
  row.innerHTML = `
    <div class="avatar user">You</div>
    <div class="bubble">${escapeHtml(text)}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** ------------ Initial Render (초기 인사만 표시) ------------ **/
addAssistant("Honey, Thanks for the tip❤️  Let’s go deeper—tell Scarlett anything.");

/** ------------ 레이아웃: 컴포저를 항상 푸터 위로 ------------ **/
function applyLayoutPadding(){
  const footerEl = document.querySelector('footer');
  const composerEl = document.querySelector('.composer');
  const fh = footerEl ? footerEl.offsetHeight : 0;
  const ch = composerEl ? composerEl.offsetHeight :
    parseInt(getComputedStyle(document.documentElement).getPropertyValue('--composerH')) || 58;
  document.documentElement.style.setProperty('--footerH', fh + 'px');
  if (chatEl) chatEl.style.paddingBottom = (fh + ch + 16) + 'px';
}
window.addEventListener('load', applyLayoutPadding);
window.addEventListener('resize', applyLayoutPadding);
if ('ResizeObserver' in window) {
  new ResizeObserver(applyLayoutPadding).observe(document.querySelector('footer'));
}

/** ------------ Send Logic (Unlimited) ------------ **/
async function sendMessage(){
  const text = msgEl.value.trim();
  if (!text) return;

  addUser(text);
  conversation.push({ role: "user", content: text });
  msgEl.value = "";
  sendEl.disabled = true;

  try{
    const res = await fetch(API_PATH, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: conversation })  /* ← 모델/프롬프트는 서버에서만 */
    });
    const data = await res.json();
    if (!res.ok || !data?.ok) throw new Error((data && (data.error?.message || data.error)) || ("HTTP " + res.status));

    const reply = data.content || "…";
    addAssistant(reply);
    conversation.push({ role: "assistant", content: reply });
  }catch(err){
    console.error("chat error:", err);
    addAssistant("Oops, something went wrong. Please try again.");
  }finally{
    sendEl.disabled = false;
    msgEl.focus();
  }
}
msgEl.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
sendEl.addEventListener("click", sendMessage);

/** ------------ Clear chat ------------ **/
clearEl.addEventListener("click", () => {
  chatEl.innerHTML = "";
  conversation = [];
  addAssistant("Honey, what should we do today?");
});

/* 이하 Tip/Gallery/Rules/Menu 스크립트는 기존 그대로 유지 */
</script>
