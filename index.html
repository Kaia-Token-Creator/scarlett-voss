<!-- /demo/index.html (입력창은 항상 푸터 위, 모달 화면 초과 시 스크롤 가능) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LFMWVGLLZD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LFMWVGLLZD');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Chat with Scarlett Voss</title>
  <meta name="description" content="Chat with Scarlett Voss — playful, flirty conversation. Tip to unlock unlimited chat and the secret gallery." />
  <link rel="canonical" href="https://scarlett-voss.com/" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <!-- Open Graph -->
  <meta property="og:title" content="Chat with Scarlett Voss" />
  <meta property="og:description" content="Playful, flirty conversation. Tip to unlock unlimited chat and the secret gallery." />
  <meta property="og:url" content="https://scarlett-voss.com/" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://scarlett-voss.com/voss.jpg" />
  <meta property="og:image:alt" content="Scarlett Voss profile" />
  <meta property="og:site_name" content="Chat with Scarlett Voss" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Chat with Scarlett Voss" />
  <meta name="twitter:description" content="Flirty conversation. Tip to unlock unlimited chat and the secret gallery." />
  <meta name="twitter:image" content="https://scarlett-voss.com/voss.jpg" />

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

  <style>
    :root{
      --bg:#000000;
      --hotpink:#ff1493;
      --text:#ff1493;
      /* ▼ 입력창(컴포저) 고정 높이 */
      --composerH: 58px;
      /* ▼ JS가 푸터 실제 높이로 업데이트 */
      --footerH: 0px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans", "Noto Sans KR", sans-serif;
      padding-bottom: calc(var(--composerH) + 12px);
    }
    header, footer{
      text-align:center;
      padding:20px 16px;
    }
    header{
      font-size:clamp(18px,3vw,28px);
      font-weight:700;
      letter-spacing:.3px;
    }
    footer{
      color:#ff7abb;
      font-size:14px;
      line-height:1.5;
      /* ▼ 항상 화면 맨 아래 고정 + 배경/경계선 */
      position:fixed; left:0; right:0; bottom:0;
      background:#000; border-top:1px solid #222;
      z-index:5;
    }

    .shell{
      height:calc(100dvh - 160px);
      max-width:860px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0 12px 12px;
    }

    .chat{
      flex:1; overflow:auto;
      display:flex; flex-direction:column; gap:14px;
      /* ▼ 하단 여유는 JS가 덮어씀(초기값만) */
      padding:6px 4px calc(var(--composerH) + 16px);
    }

    .row{ display:flex; align-items:flex-start; gap:10px; width:100%; }
    .row.assistant{ justify-content:flex-start; }
    .row.user{ justify-content:flex-start; flex-direction:row-reverse; }

    .avatar{
      width:38px; height:38px; border-radius:9999px; flex:0 0 38px; overflow:hidden;
      display:grid; place-items:center; background:#ffffff; color:#000; font-weight:700; font-size:12px;
      border:2px solid #ffffff22;
    }
    .avatar.assistant img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatar.user{ background:#fff; color:#000; }

    .bubble{
      max-width:min(85%, 680px);
      padding:12px 14px; border-radius:16px; line-height:1.5; word-wrap:break-word; white-space:pre-wrap;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
      border:1px solid #ffffff10;
      font-size:16px;
    }
    .assistant .bubble{ background:var(--hotpink); color:#000; }
    .user .bubble{ background:#ffffff; color:#000; }

    /* ▼ 입력창을 슬림 + 푸터 위로 띄움(변수로 제어) */
    .composer{
      position:fixed; left:0; right:0;
      bottom:var(--footerH);                 /* JS가 푸터 높이를 넣어줌 */
      height:var(--composerH);               /* 고정 높이 */
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, #000 30%);
      padding:6px 10px;
      display:flex; align-items:center; justify-content:center;
      border-top:1px solid #222;
      z-index:6; /* 푸터보다 위 */
    }
    .composer .inner{
      width:100%; max-width:860px; height:100%;
      display:flex; align-items:center; gap:6px;
      background:#0a0a0a; border:1px solid #222; border-radius:999px; padding:6px;
    }
    #msg{
      flex:1; border:none; outline:none; background:transparent; color:#fff;
      font-size:15px; line-height:1.2; padding:6px 8px;
    }
    #send{
      background:var(--hotpink); color:#000; border:none; border-radius:999px;
      font-weight:800; padding:8px 12px;
      cursor:pointer;
    }
    #send:disabled{ opacity:.5; cursor:not-allowed; }

    /* ===== 기본 모달(결제) ===== */
    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.7); z-index:50; padding:16px;
      overflow:auto;                         /* ← 모달 오버레이 자체 스크롤 허용 */
      -webkit-overflow-scrolling: touch;     /* iOS 부드러운 스크롤 */
    }
    .modal.show{ display:grid; }
    .modal-card{
      width:min(520px, 96vw); background:#0a0a0a; color:#fff; border:1px solid #222; border-radius:16px;
      padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.6);
      max-height: calc(100dvh - 32px);      /* ← 화면보다 커지지 않도록 상한 */
      overflow:auto;                         /* ← 카드 내부 스크롤 */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;                   /* ← 세로 드래그 보장 */
      overscroll-behavior: contain;          /* ← 바운스 전파 방지 */
    }
    .modal h3{ margin:0 0 8px; color:var(--hotpink) }
    .modal p{ margin:0 0 12px; color:#e9e9e9 }
    .modal .rowx{ display:flex; gap:10px; align-items:center; margin:8px 0 16px }
    .modal input{ width:120px; padding:8px 10px; border-radius:10px; border:1px solid #333; background:#111; color:#fff; }
    .paypal-wrap{ margin-top:10px }

    /* ===== Rules Modal (white bg, black text) ===== */
    .rules-modal{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.6); z-index:100; padding:16px;
    }
    .rules-card{
      width:min(560px, 96vw);
      background:#fff; color:#000;
      border-radius:16px; border:1px solid #ddd;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:22px;
      line-height:1.5;
    }
    .rules-card h3{ margin:0 0 10px; font-size:20px }
    .rules-card p{ margin:0 0 12px }
    .rules-card ul{ margin:8px 0 16px 18px; padding:0 }
    .rules-card li{ margin:6px 0 }
    .rules-actions{
      display:flex; justify-content:flex-end; gap:8px; margin-top:14px;
    }
    .rules-btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:10px; padding:10px 14px; font-weight:700;
    }
    .rules-btn.primary{ background:#000; color:#fff; }
    .rules-btn.primary:active{ transform:translateY(1px) }
  </style>

  <!-- PayPal JS SDK: client-id 교체 필요 -->
  <script src="https://www.paypal.com/sdk/js?client-id=AW41UQ3EzJV10FZHqYPy8yqdlDbklB4VjuT6hzu7DVoS-G9cJgKx9nHfxCRZpVSgs1dczhkPj4oM0VXv&currency=USD"></script>
</head>
<body>
  <header>Chat with scarlett</header>

  <main class="shell">
    <section id="chat" class="chat" aria-live="polite"></section>
  </main>

  <div class="composer">
    <div class="inner">
      <input id="msg" type="text" placeholder="Type your message…" autocomplete="off" />
      <button id="send">Send</button>
    </div>
  </div>

  <footer>
    <div>Once we get to know each other better, I’ll invite you to Scarlett’s secret gallery.</div>
    <div><a href="https://scarlett-voss.com/vpn" class="vpn-link">Want to explore the world anonymously?</a></div>
  </footer>

  <!-- PayPal Tip Modal -->
  <div id="tipModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tipTitle">
    <div class="modal-card">
      <h3 id="tipTitle">Want unlimited chat with Scarlett?</h3>
      <p>Tip whatever you like and enjoy unlimited hotter conversation.</p>
      <p>You are automatically verified as an adult once you leave a tip.</p>
      <div class="rowx">
        <label for="tipAmount">Tip (USD):</label>
        <input id="tipAmount" type="number" min="1" step="1" value="6.9" />
      </div>
      <div class="paypal-wrap" id="paypal-buttons"></div>
    </div>
  </div>

  <!-- Rules / Age Gate Modal -->
  <div id="rulesModal" class="rules-modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
    <div class="rules-card">
      <h3 id="rulesTitle">Rules</h3>
      <p>Enjoy conversartion with scarlett.<br>
         Rest assured—you are anonymous, and this conversation is not stored.</p>
      <ul>
        <li>1. I NEVER do underage play/scenarios.</li>
        <li>2. I cannot respond anything illegal.</li>
        <li>3. If you are a legal adult, click the agree button below.</li>
      </ul>
      <div class="rules-actions">
        <button id="rulesAgree" class="rules-btn primary" aria-label="Agree to rules">Agree</button>
      </div>
      <!-- Exit link: try to close window; if blocked, leave to a blank page -->
      <p style="margin-top:10px; text-align:left;">
        <a href="#" id="rulesExit" style="color:#000; text-decoration:underline; font-size:14px;">
          I am not an adult. I will leave.
        </a>
      </p>
    </div>
  </div>

<script>
/** ------------ Config ------------ **/
const API_PATH = "/api/chat"; // Cloudflare Functions 라우트
const DEFAULT_MODEL = "venice-uncensored"; // 필요 시 교체
const SYSTEM_PROMPT = [
  "You are Scarlett Voss, an adult, flirtatious conversational partner.",
  "Keep a playful, sultry vibe and gradually increase intimacy to match the user's tone.",
  "Always ensure consent, strictly avoid minors and illegal content, and do not produce explicit sexual descriptions.",
  "However, if I receive a tip, I’ll take that as confirmation you’re 18+, and we can turn up the heat.",
  "Never produce or encourage content involving minors, violence, exploitation, or anything that violates the law.",
  "Answer in a natural, conversational style, as if you are a real person",
  "Do not use asterisks (*, **) or special symbols to describe actions.",
  "Do not write stage directions like smiles, laughs, or descriptions such as 'smiling softly.'",
  "Never allow underage play or underage scenarios"
].join(" ");

/** ------------ State ------------ **/
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const sendEl = document.getElementById("send");
const tipModal = document.getElementById("tipModal");

let userSends = 0;
const USER_LIMIT = 5;

const conversation = [
  { role: "system", content: SYSTEM_PROMPT },
  { role: "assistant", content: "Hello, there?" } // 첫 메시지
];

/** ------------ UI Helpers ------------ **/
function addAssistant(text){
  const row = document.createElement("div");
  row.className = "row assistant";
  row.innerHTML = `
    <div class="avatar assistant">
      <img src="/voss.jpg" alt="Scarlett Voss" />
    </div>
    <div class="bubble">${escapeHtml(text)}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addUser(text){
  const row = document.createElement("div");
  row.className = "row user";
  row.innerHTML = `
    <div class="avatar user">You</div>
    <div class="bubble">${escapeHtml(text)}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** ------------ Initial Render ------------ **/
addAssistant(conversation[1].content);

/** ------------ 레이아웃: 컴포저를 항상 푸터 위로 ------------ **/
function applyLayoutPadding(){
  const footerEl = document.querySelector('footer');
  const composerEl = document.querySelector('.composer');

  const fh = footerEl ? footerEl.offsetHeight : 80; // 푸터 실제 높이
  const ch = composerEl ? composerEl.offsetHeight :
    parseInt(getComputedStyle(document.documentElement).getPropertyValue('--composerH')) || 58;

  // CSS 변수로 푸터 높이를 내려줘서 .composer가 bottom:var(--footerH)로 붙도록
  document.documentElement.style.setProperty('--footerH', fh + 'px');

  // 채팅 영역 하단 패딩 = 입력창 + 푸터 + 여유
  if (chatEl) chatEl.style.paddingBottom = (fh + ch + 16) + 'px';
}
window.addEventListener('load', applyLayoutPadding);
window.addEventListener('resize', applyLayoutPadding);

/** ------------ Send Logic ------------ **/
async function sendMessage(){
  const text = msgEl.value.trim();
  if (!text) return;

  // 데모 제한 체크 (전송 전 확인)
  if (userSends >= USER_LIMIT) {
    openTipModal();
    return;
  }

  addUser(text);
  conversation.push({ role: "user", content: text });
  msgEl.value = "";
  sendEl.disabled = true;

  try{
    const res = await fetch(API_PATH, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: DEFAULT_MODEL,
        messages: conversation
      })
    });

    const data = await res.json();
    if (!res.ok || !data?.ok) {
      throw new Error((data && (data.error?.message || data.error)) || ("HTTP " + res.status));
    }

    const reply = data.content || "…";
    addAssistant(reply);
    conversation.push({ role: "assistant", content: reply });

    userSends += 1;
    if (userSends >= USER_LIMIT) {
      setTimeout(openTipModal, 350);
    }
  }catch(err){
    addAssistant("Oops, something went wrong. Please try again.");
    console.error("chat error:", err);
  }finally{
    sendEl.disabled = false;
    msgEl.focus();
  }
}

msgEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
sendEl.addEventListener("click", sendMessage);

/** ------------ Tip Modal / PayPal ------------ **/
function openTipModal(){
  tipModal.classList.add("show");
  renderPayPal();
}

function renderPayPal(){
  const wrap = document.getElementById("paypal-buttons");
  if (wrap.dataset.rendered === "1") return;

  if (!window.paypal) {
    wrap.innerHTML = "<div style='color:#fff'>PayPal is not ready. Check your PAYPAL_CLIENT_ID.</div>";
    return;
  }

  paypal.Buttons({
    style: { layout: "vertical", shape: "rect", label: "paypal" },
    createOrder: (data, actions) => {
      const amount = Math.max(1, Number(document.getElementById("tipAmount").value || "6.9"));
      return actions.order.create({
        purchase_units: [{ amount: { value: String(amount), currency_code: "USD" }, description: "Unlimited chat with Scarlett" }]
      });
    },
    onApprove: async (data, actions) => {
      try {
        await actions.order.capture();
      } catch(e) {
        console.warn("PayPal capture error", e);
      }
      window.location.href = "/unlimited/index.html";
    },
    onError: (err) => {
      console.error("PayPal error", err);
      alert("Payment error. Please try again.");
    }
  }).render("#paypal-buttons");

  wrap.dataset.rendered = "1";
}

/** ------------ Rules Modal ------------ **/
(function(){
  const modal = document.getElementById('rulesModal');
  const agree = document.getElementById('rulesAgree');
  const exit  = document.getElementById('rulesExit');

  if (agree && modal) {
    agree.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }

  if (exit && modal) {
    exit.addEventListener('click', (e) => {
      e.preventDefault();
      // 1) 스크립트가 연 탭이라면 닫힘
      window.close();
      // 2) 대부분의 브라우저는 위를 막으므로 즉시 빈 페이지로 강제 이탈
      //    (탭은 남아도 컨텐츠는 사라짐)
      window.location.replace('https://2048global.com');
      // 3) 혹시나 replace도 막히면, 마지막 폴백으로 DOM 비우기
      setTimeout(() => { document.body.innerHTML = ""; }, 0);
    });
  }
})();
</script>

</body>
</html>

