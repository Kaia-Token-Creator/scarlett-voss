<!-- /image/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>uncensored image generator</title>
<meta name="theme-color" content="#000000" />
<style>
  :root{
    --bg:#000000;
    --hotpink:#ff1493;
    --muted:#ff86c8;
    --card:#0a0a0a;
    --border:#1a1a1a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--hotpink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Noto Sans KR", sans-serif;
  }
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{padding:12px 0; text-align:center}
  h1{margin:0;font-size:clamp(20px,5vw,28px); letter-spacing:0.5px}
  p.sub{margin:.25rem 0 0; color:var(--muted); font-size:13px}

  form.generator{
    display:grid; gap:12px; margin:16px 0 12px;
    grid-template-columns: 1fr;
    background:var(--card); padding:12px; border:1px solid var(--border);
    border-radius:14px;
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  label{font-size:13px; color:var(--muted)}
  input[type="file"], input[type="number"], input[type="text"], textarea, select, button{
    width:100%; background:#0f0f0f; color:var(--hotpink); border:1px solid var(--border);
    border-radius:12px; padding:12px; outline:none;
  }
  textarea{min-height:96px; resize:vertical}
  .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @media (max-width:640px){ .two-col{grid-template-columns:1fr} }

  .hint{font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:10px; align-items:center}
  button.primary{
    background:var(--hotpink); color:#000; font-weight:700; border:0;
    padding:14px 16px; border-radius:999px; cursor:pointer; width:100%;
  }
  button.primary:disabled{opacity:.6; cursor:not-allowed}

  .progress{height:6px; background:#1c1c1c; border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--hotpink); transition:width .2s ease}

  .grid{
    display:grid; gap:10px; margin:14px 0 40px;
    grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    display:flex; flex-direction:column;
  }
  .thumb{width:100%; aspect-ratio:1/1; object-fit:cover; display:block}
  .meta{padding:8px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
  .dl{color:var(--hotpink); text-decoration:none; font-weight:700}
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:var(--hotpink); color:#000; padding:10px 14px; border-radius:999px;
    font-weight:700; display:none
  }
  footer{padding:20px 0 40px; text-align:center; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>uncensored image generator</h1>
      <p class="sub">Upload an optional reference image, write a prompt, pick how many images (1–100), then generate.</p>
    </header>

    <form class="generator" id="genForm">
      <div class="row">
        <label>Reference image (optional)</label>
        <input type="file" id="refFile" accept="image/*" />
        <div class="hint">If provided, the reference will be edited per your prompt.</div>
      </div>

      <div class="row">
        <label>Prompt</label>
        <textarea id="prompt" placeholder="e.g., dreamy summer portrait, soft glow, shallow depth of field, 1:1"></textarea>
      </div>

      <div class="two-col">
        <div>
          <label>Count (1–100)</label>
          <input id="count" type="number" min="1" max="100" value="4" inputmode="numeric" />
        </div>
        <div>
          <label>Size</label>
          <select id="size">
            <option value="1024x1024">1024 × 1024</option>
            <option value="768x1024">768 × 1024 (portrait)</option>
            <option value="1024x768">1024 × 768 (landscape)</option>
          </select>
        </div>
      </div>

      <div class="two-col">
        <div>
          <label>Image model</label>
          <input id="model" type="text" value="venice-sd35" />
          <div class="hint">Note: <code>venice-uncensored</code> is a text model; use an image-capable model here (e.g., venice-sd35).</div>
        </div>
        <div>
          <label>Site</label>
          <input id="site" type="text" value="https://scarlett-voss.com" />
          <div class="hint">CORS 허용 도메인(서버에서 ALLOWED_ORIGIN을 설정했다면 여기에 맞춰주세요)</div>
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="runBtn" type="submit">Generate</button>
      </div>

      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
    </form>

    <section class="grid" id="outGrid" aria-live="polite"></section>
    <div class="toast" id="toast"></div>

    <footer>Built on Venice API — private & uncensored. Be mindful of local laws & host policies.</footer>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const form = $('#genForm');
const refFile = $('#refFile');
const promptEl = $('#prompt');
const countEl = $('#count');
const sizeEl = $('#size');
const modelEl = $('#model');
const bar = $('#bar');
const grid = $('#outGrid');
const toast = $('#toast');
const runBtn = $('#runBtn');

function showToast(msg){
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(()=> toast.style.display='none', 2400);
}

function setProgress(p){
  bar.style.width = Math.max(0, Math.min(100, p)) + '%';
}

async function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function addImageCard(src, index){
  const card = document.createElement('div');
  card.className = 'card';
  const img = document.createElement('img');
  img.className = 'thumb';
  img.src = src;
  img.alt = 'generated image ' + (index+1);
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `<span>#${index+1}</span><a class="dl" download="gen_${Date.now()}_${index+1}.png" href="${src}">save</a>`;
  card.appendChild(img);
  card.appendChild(meta);
  grid.appendChild(card);
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const prompt = (promptEl.value || '').trim();
  if (!prompt){ showToast('프롬프트를 입력해 주세요.'); return; }

  let n = parseInt(countEl.value, 10);
  if (!Number.isFinite(n) || n < 1) n = 1;
  if (n > 100) n = 100;

  const [w,h] = (sizeEl.value || '1024x1024').split('x').map(Number);
  const model = (modelEl.value || 'venice-sd35').trim();

  runBtn.disabled = true;
  setProgress(0);
  grid.innerHTML = '';

  // Prepare reference dataURL if present
  let referenceImageData = '';
  const f = refFile.files?.[0];
  if (f) {
    try {
      referenceImageData = await fileToDataURL(f);
    } catch(e) {
      console.error(e);
      showToast('참고 이미지 읽기 실패');
    }
  }

  try{
    // POST once (server will fan-out if generate, or loop if edit)
    const res = await fetch('/api/image', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        prompt, count: n, model,
        width: w, height: h,
        referenceImageData
      })
    });

    if (!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error('Server error: '+ res.status + ' ' + t);
    }
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Unknown error');

    const images = Array.isArray(data.images) ? data.images : [];
    // Render in order
    for (let i=0; i<images.length; i++){
      addImageCard(images[i], i);
      setProgress(Math.round(((i+1)/images.length)*100));
      await new Promise(r=> setTimeout(r, 40)); // tiny yield for paint
    }
    if (images.length === 0) showToast('이미지 없음. 프롬프트/모델을 확인하세요.');
  }catch(err){
    console.error(err);
    showToast('실패: ' + (err?.message || err));
  }finally{
    runBtn.disabled = false;
    setProgress(100);
    setTimeout(()=> setProgress(0), 800);
  }
});
</script>
</body>
</html>
