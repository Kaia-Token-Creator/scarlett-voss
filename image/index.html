<!-- /image/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>uncensored image generator</title>
<meta name="theme-color" content="#000000" />
<style>
  :root{
    --bg:#000000;
    --hotpink:#ff1493;
    --muted:#ff86c8;
    --card:#0a0a0a;
    --border:#1a1a1a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--hotpink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Noto Sans KR", sans-serif;
  }
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{padding:12px 0; text-align:center}
  h1{margin:0;font-size:clamp(20px,5vw,28px); letter-spacing:0.5px}
  p.sub{margin:.25rem 0 0; color:var(--muted); font-size:13px}

  form.generator{
    display:grid; gap:12px; margin:16px 0 12px;
    grid-template-columns: 1fr;
    background:var(--card); padding:12px; border:1px solid var(--border);
    border-radius:14px;
  }
  label{font-size:13px; color:var(--muted)}
  input[type="file"], input[type="number"], textarea, select, button{
    width:100%; background:#0f0f0f; color:var(--hotpink); border:1px solid var(--border);
    border-radius:12px; padding:12px; outline:none;
  }
  textarea{min-height:96px; resize:vertical}
  .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @media (max-width:640px){ .two-col{grid-template-columns:1fr} }

  .actions{display:flex; gap:10px; align-items:center}
  button.primary{
    background:var(--hotpink); color:#000; font-weight:700; border:0;
    padding:14px 16px; border-radius:999px; cursor:pointer; width:100%;
  }
  button.primary:disabled{opacity:.6; cursor:not-allowed}

  .progress{height:6px; background:#1c1c1c; border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--hotpink); transition:width .2s ease}

  /* 한 줄로 위에서 아래로 차곡차곡 */
  .list{display:flex; flex-direction:column; gap:10px; margin:14px 0 40px;}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    display:flex; flex-direction:column;
  }
  .thumb{width:100%; aspect-ratio:1/1; object-fit:cover; display:block}
  .meta{padding:8px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
  .dl{color:var(--hotpink); text-decoration:none; font-weight:700}
  .err{color:#fff; background:#8b0000; border-left:4px solid #ff5555; padding:10px; border-radius:10px; font-size:12px}

  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:var(--hotpink); color:#000; padding:10px 14px; border-radius:999px;
    font-weight:700; display:none
  }
  footer{padding:20px 0 40px; text-align:center; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>uncensored image generator</h1>
      <p class="sub">Upload an optional reference image, write a prompt, set how many (1–100). Images will appear one by one.</p>
    </header>

    <form class="generator" id="genForm">
      <div>
        <label>Reference image (optional)</label>
        <input type="file" id="refFile" accept="image/*" />
      </div>

      <div>
        <label>Prompt</label>
        <textarea id="prompt" placeholder="e.g., dreamy summer portrait, soft glow, 1:1, subtle freckles"></textarea>
      </div>

      <div class="two-col">
        <div>
          <label>Count (1–100)</label>
          <input id="count" type="number" min="1" max="100" value="4" inputmode="numeric" />
        </div>
        <div>
          <label>Size</label>
          <select id="size">
            <option value="1024x1024">1024 × 1024</option>
            <option value="768x1024">768 × 1024 (portrait)</option>
            <option value="1024x768">1024 × 768 (landscape)</option>
          </select>
        </div>
      </div>

      <div class="two-col">
        <div>
          <label>Image model</label>
          <input id="model" type="text" value="venice-sd35" />
        </div>
        <div>
          <label>Rate limit friendly</label>
          <select id="pace">
            <option value="1500">Normal (1.5s gap)</option>
            <option value="300">Fast (0.3s gap)</option>
            <option value="2500">Safe (2.5s gap)</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="runBtn" type="submit">Generate</button>
      </div>

      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
    </form>

    <section class="list" id="outList" aria-live="polite"></section>
    <div class="toast" id="toast"></div>

    <footer>Built on Venice API — private & uncensored. Check host/region policies.</footer>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const form = $('#genForm');
const refFile = $('#refFile');
const promptEl = $('#prompt');
const countEl = $('#count');
const sizeEl = $('#size');
const modelEl = $('#model');
const paceEl  = $('#pace');
const bar = $('#bar');
const list = $('#outList');
const toast = $('#toast');
const runBtn = $('#runBtn');

function showToast(msg){
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(()=> toast.style.display='none', 2400);
}
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

async function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function addImageCard(src, index){
  const card = document.createElement('div');
  card.className = 'card';
  const img = document.createElement('img');
  img.className = 'thumb';
  img.src = src;
  img.alt = 'generated image ' + (index+1);
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `<span>#${index+1}</span><a class="dl" download="gen_${Date.now()}_${index+1}.png" href="${src}">save</a>`;
  card.appendChild(img);
  card.appendChild(meta);
  list.appendChild(card);
}

function addErrorCard(message, index){
  const card = document.createElement('div');
  card.className = 'card';
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `<span>#${index+1}</span><span>failed</span>`;
  const err = document.createElement('div');
  err.className = 'err';
  err.textContent = (''+message).slice(0,250);
  card.appendChild(meta);
  card.appendChild(err);
  list.appendChild(card);
}

async function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// 백엔드: 항상 1장만 반환하도록 만들어 놓았음
async function generateOne({prompt, w, h, model, referenceImageData, signal}){
  const res = await fetch('/api/image', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ prompt, width:w, height:h, model, referenceImageData }),
    signal
  });
  if (!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`Server ${res.status}: ${t}`);
  }
  const data = await res.json();
  if (!data.ok || !data.image){
    throw new Error(data.error || 'no image returned');
  }
  return data.image;
}

// 재시도(3회, 지수 백오프)
async function generateWithRetry(opts, attempt=1){
  try{
    return await generateOne(opts);
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    // 4xx 중 429만 재시도, 5xx/네트워크 오류 재시도
    const retriable = /429|5\d\d|network|timeout|fetch/i.test(msg);
    if (retriable && attempt < 3){
      const delay = 600 * Math.pow(2, attempt-1); // 600ms, 1200ms
      await sleep(delay);
      return await generateWithRetry(opts, attempt+1);
    }
    throw e;
  }
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const prompt = (promptEl.value || '').trim();
  if (!prompt){ showToast('프롬프트를 입력해 주세요.'); return; }

  let n = parseInt(countEl.value, 10);
  if (!Number.isFinite(n) || n < 1) n = 1;
  if (n > 100) n = 100;

  const [w,h] = (sizeEl.value || '1024x1024').split('x').map(Number);
  const model = (modelEl.value || 'venice-sd35').trim();
  const gapMs = parseInt(paceEl.value, 10) || 1500;

  runBtn.disabled = true;
  setProgress(0);
  // 기존 결과 유지하고 추가로 아래에 이어붙이려면 다음 줄을 주석 처리
  list.innerHTML = '';

  // 참고 이미지 dataURL 준비(있을 때만)
  let referenceImageData = '';
  const f = refFile.files?.[0];
  if (f) {
    try { referenceImageData = await fileToDataURL(f); }
    catch { showToast('참고 이미지 읽기 실패'); }
  }

  try{
    for (let i=0; i<n; i++){
      // 순차 호출: 한 장 끝나야 다음 장 요청
      try{
        const imageData = await generateWithRetry({ prompt, w, h, model, referenceImageData });
        addImageCard(imageData, i);
      }catch(err){
        console.error(err);
        addErrorCard(err?.message || err, i);
      }
      setProgress(Math.round(((i+1)/n)*100));
      if (i < n-1) await sleep(gapMs); // 레이트리밋 완화
    }
  } finally {
    runBtn.disabled = false;
    setTimeout(()=> setProgress(0), 800);
  }
});
</script>
</body>
</html>
